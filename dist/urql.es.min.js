import{make as r,pipe as t,onPush as n,onEnd as e,subscribe as o,share as i,filter as a,map as u,tap as c,merge as s,mergeMap as f,takeUntil as p,makeSubject as v,onStart as d,take as h,toPromise as l}from"wonka";import{GraphQLError as y,print as g,visit as m}from"graphql";import w from"fast-json-stable-stringify";import O from"graphql-tag";import{createContext as b,useRef as k,useState as x,useCallback as q,useEffect as E,useContext as N,useMemo as S}from"react";function P(){return(P=Object.assign||function(r){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var e in n)Object.prototype.hasOwnProperty.call(n,e)&&(r[e]=n[e])}return r}).apply(this,arguments)}var j=function(r,t){var n="";return void 0!==r?n="[Network] "+r.message:(void 0!==t&&t.forEach(function(r){n+="[GraphQL] "+r.message+"\n"}),n.trim())},_=function(r){return"string"==typeof r?new y(r):"object"==typeof r&&r.message?new y(r.message,r.nodes,r.source,r.positions,r.path,r.originalError,r.extensions||{}):r};function Q(){return this.message}var M=function(r){function t(t){var n=t.networkError,e=t.response,o=(t.graphQLErrors||[]).map(_),i=j(n,o);r.call(this,i),this.name="CombinedError",this.message=i,this.graphQLErrors=o,this.networkError=n,this.response=e}return r&&(t.__proto__=r),(t.prototype=Object.create(r&&r.prototype)).constructor=t,t.prototype.toString=Q,t}(Error),A=function(r){for(var t=5381,n=0,e=0|r.length;n<e;n++)t=(t<<5)+t+r.charCodeAt(n);return t>>>0},D=Object.create(null);function R(r,t){return r+(void 0!==t.name?t.name.value:"")}var C=function(r,t){var n=function(r){if(void 0!==r.__key)return r.__key;var t=r.definitions.reduce(R,"");if("production"!==process.env.NODE_ENV&&""!==t){var n=g(r);t in D?D[t]!==n&&console.warn("Warning: Encountered multiple DocumentNodes with the same name."):D[t]=n}""===t&&(t=g(r));var e=A(t);return r.__key=e,e}(r);return null==t?n:A(""+n+w(t))},L=function(r,t){var n="string"==typeof r?O([r]):r;return{key:C(n,t),query:n,variables:t||{}}},W=function(r,t){if(void 0===t&&(t=[]),Array.isArray(r))r.forEach(function(r){return W(r,t)});else if("object"==typeof r&&null!==r)for(var n in r)if(r.hasOwnProperty(n)){var e=r[n];"__typename"===n&&"string"==typeof e?t.push(e):"object"==typeof e&&null!==e&&W(e,t)}return t};function U(r,t,n){return n.indexOf(r)===t}var $=function(r){return W(r).filter(U)},F=function(r){return void 0!==r.selectionSet&&void 0!==r.selectionSet.selections&&P({},r,{selectionSet:P({},r.selectionSet,{selections:r.selectionSet.selections.concat([{kind:"Field",name:{kind:"Name",value:"__typename"}}])})})},T=function(r){return m(r,{Field:F,InlineFragment:F,OperationDefinition:F})},I=function(i){return r(function(r){var a,u,c=r[1],s=!1,f=t(i,n(r[0]),e(c),o(function(r){void 0===a?u=r:s||(a(r),c(),f())}))[0];if(void 0===u)throw new Promise(function(r){a=r});return function(){s=!0,f()}})},J=function(){},V=function(r){var t=r.operationName;return"subscription"!==t&&"query"!==t};function G(r){return""+r}var H=function(r){var t=r.error,n={data:r.data,error:void 0};return void 0!==t&&(n.error={networkError:""+t.networkError,graphQLErrors:t.graphQLErrors.map(G)}),n},Y=function(r,t){var n=t.error,e={operation:r,data:t.data,error:void 0};return void 0!==n&&(e.error=new M({networkError:new Error(n.networkError),graphQLErrors:n.graphQLErrors})),e},z=function(r){var n={},e=function(r){return!V(r)&&void 0!==n[r.key]};function o(r){return!e(r)}function f(r){return e(r)}function p(r){return Y(r,n[r.key])}function v(r){var t=r.operation;if(!V(t)){var e=H(r);n[t.key]=e}}function d(r){delete n[r.operation.key]}var h=function(r){var n=r.client,e=r.forward;return function(r){var h=i(r),l=t(h,a(o),e),y=t(h,a(f),u(p));return n.suspense?l=t(l,c(v)):y=t(y,c(d)),s([l,y])}};return h.restoreData=function(r){return P(n,r)},h.extractData=function(){return P({},n)},r&&r.initialState&&h.restoreData(r.initialState),h},B=function(r){var t=r.operationName;return"mutation"!==t&&"query"!==t};function K(r){return P({},r,{query:T(r.query)})}function X(r){return B(r)}var Z=function(r){var n=r.forward,e=r.client,o=new Map,f=Object.create(null),p=K,v=tr(o,f,e),d=nr(o,f),h=function(r){var t=r.context.requestPolicy;return"query"===r.operationName&&"network-only"!==t&&("cache-only"===t||o.has(r.key))};function l(r){return!B(r)&&h(r)}function y(r){var t=r.context.requestPolicy,n=o.get(r.key);return"cache-and-network"===t&&rr(e,r),void 0!==n?n:{operation:r,data:void 0,error:void 0}}function g(r){return!B(r)&&!h(r)}function m(r){r.operation&&"mutation"===r.operation.operationName?v(r):r.operation&&"query"===r.operation.operationName&&d(r)}return function(r){var e=i(r),o=t(e,a(l),u(y)),f=t(s([t(e,a(g),u(p)),t(e,a(X))]),n,c(m));return s([o,f])}},rr=function(r,t){return r.reexecuteOperation(P({},t,{context:P({},t.context,{requestPolicy:"network-only"})}))},tr=function(r,t,n){function e(t){if(r.has(t)){var e=r.get(t).operation;r.delete(t),rr(n,e)}}return function(r){var n=new Set;function o(r){return n.add(r)}$(r.data).forEach(function(r){var n=t[r]||(t[r]=new Set);n.forEach(o),n.clear()}),n.forEach(e)}},nr=function(r,t){return function(n){var e=n.operation.key;void 0!==n.data&&(r.set(e,n),$(n.data).forEach(function(r){(t[r]||(t[r]=new Set)).add(e)}))}},er=function(r){return"subscription"===r.operationName};function or(r){return!er(r)}var ir=function(n){var e=n.forwardSubscription;function o(t){var n=e({key:t.key.toString(36),query:g(t.query),variables:t.variables,context:P({},t.context)});return r(function(r){var e=r[0],o=n.subscribe({next:function(r){return e({operation:t,data:r.data||void 0,error:Array.isArray(r.errors)?new M({graphQLErrors:r.errors,response:void 0}):void 0})},error:function(r){return e({operation:t,data:void 0,error:new M({networkError:r,response:void 0})})},complete:r[1]});return function(){return o.unsubscribe()}})}return function(r){var n=r.forward,e=o;return function(r){var o=i(r),u=t(o,a(er),f(function(r){var n=r.key,i=t(o,a(function(r){return"teardown"===r.operationName&&r.key===n}));return t(e(r),p(i))})),c=t(o,a(or),n);return s([u,c])}}};function ar(r){return console.log("[Exchange debug]: Incoming operation: ",r)}function ur(r){return console.log("[Exchange debug]: Completed operation: ",r)}var cr=function(r){var n=r.forward;return function(r){return t(r,c(ar),n,c(ur))}},sr=function(r){var n=r.forward,e=new Set,o=function(r){var t=r.key,n=r.operationName;if("teardown"===n)return e.delete(t),!0;if("query"!==n)return!0;var o=e.has(t);return e.add(t),!o},i=function(r){e.delete(r.operation.key)};return function(r){var e=t(r,a(o));return t(n(e),c(i))}};function fr(r){var t=r.operationName;return"query"===t||"mutation"===t}var pr=function(r){var n=r.forward,e=fr;function o(r){return!e(r)}return function(r){var u=i(r),c=t(u,a(e),f(function(r){var n=r.key,e=t(u,a(function(r){return"teardown"===r.operationName&&r.key===n}));return t(vr(r),p(e))})),v=t(u,a(o),n);return s([c,v])}},vr=function(t){if("subscription"===t.operationName)throw new Error("Received a subscription operation in the httpExchange. You are probably trying to create a subscription. Have you added a subscriptionExchange?");return r(function(r){var n=r[0],e=r[1],o="undefined"!=typeof AbortController?new AbortController:void 0,i=t.context,a="function"==typeof i.fetchOptions?i.fetchOptions():i.fetchOptions||{};function u(r){void 0!==r&&n(r),e()}if(a.then&&"function"==typeof a.then)a.then(function(r){var n=P({body:JSON.stringify({query:g(t.query),variables:t.variables}),method:"POST"},r,{headers:P({"content-type":"application/json"},r.headers),signal:void 0!==o?o.signal:void 0});dr(t,n).then(u)});else{var c=P({body:JSON.stringify({query:g(t.query),variables:t.variables}),method:"POST"},a,{headers:P({"content-type":"application/json"},a.headers),signal:void 0!==o?o.signal:void 0});dr(t,c).then(function(r){void 0!==r&&n(r),e()})}return function(){void 0!==o&&o.abort()}})},dr=function(r,t){var n;return fetch(r.context.url,t).then(function(r){return hr(t.redirect,n=r),n.json()}).then(function(t){return{operation:r,data:t.data,error:Array.isArray(t.errors)?new M({graphQLErrors:t.errors,response:n}):void 0}}).catch(function(t){if("AbortError"!==t.name)return{operation:r,data:void 0,error:new M({networkError:t,response:n})}})},hr=function(r,t){if(void 0===r&&(r="follow"),t.status<200||t.status>("manual"===r?400:300))throw new Error(t.statusText)};function lr(r){var t=r.operationName;"teardown"!==t&&"production"!==process.env.NODE_ENV&&console.warn('No exchange has handled operations of type "'+t+"\". Check whether you've added an exchange responsible for these operations.")}function yr(){return!1}var gr=function(r){return t(r,c(lr),a(yr))},mr=function(r){return 1===r.length?r[0]:function(t){var n=t.client;return r.reduceRight(function(r,t){return t({client:n,forward:r})},t.forward)}},wr=[sr,Z,pr],Or=function(r){return new br(r)},br=function(r){var t=this;this.activeOperations=Object.create(null),this.createOperationContext=function(r){var n=(r||{}).requestPolicy;return void 0===n&&(n="cache-first"),P({url:t.url,fetchOptions:t.fetchOptions},r,{requestPolicy:n})},this.createRequestOperation=function(r,n,e){return{key:n.key,query:n.query,variables:n.variables,operationName:r,context:t.createOperationContext(e)}},this.reexecuteOperation=function(r){(t.activeOperations[r.key]||0)>0&&t.dispatchOperation(r)},this.executeQuery=function(r,n){var e=t.createRequestOperation("query",r,n);return t.executeRequestOperation(e)},this.executeSubscription=function(r,n){var e=t.createRequestOperation("subscription",r,n);return t.executeRequestOperation(e)},this.executeMutation=function(r,n){var e=t.createRequestOperation("mutation",r,n);return t.executeRequestOperation(e)},this.url=r.url,this.fetchOptions=r.fetchOptions,this.suspense=!!r.suspense;var n=v(),e=n[1];this.operations$=n[0],this.dispatchOperation=e,this.exchange=mr(void 0!==r.exchanges?r.exchanges:wr),this.results$=i(this.exchange({client:this,forward:gr})(this.operations$))};br.prototype.onOperationStart=function(r){var t=r.key;this.activeOperations[t]=(this.activeOperations[t]||0)+1,this.dispatchOperation(r)},br.prototype.onOperationEnd=function(r){var t=r.key,n=this.activeOperations[t]||0;(this.activeOperations[t]=n<=0?0:n-1)<=0&&this.dispatchOperation(P({},r,{operationName:"teardown"}))},br.prototype.executeRequestOperation=function(r){var n=this,o=r.key,i=r.operationName,u=t(this.results$,a(function(r){return r.operation.key===o}));if("mutation"===i)return t(u,d(function(){return n.dispatchOperation(r)}),h(1));var c=t(u,d(function(){return n.onOperationStart(r)}),e(function(){return n.onOperationEnd(r)}));return this.suspense?I(c):c};var kr,xr=b(Or({url:"/graphql"})),qr=xr.Provider,Er=xr.Consumer,Nr=function(r){var t=k(!1),n=k(P({},r)),e=x(n.current),o=e[0],i=e[1],a=q(function(r){if(t.current)i(r);else if("function"==typeof r){var e=r(n.current);P(n.current,e)}else i(function(){return P(n.current,r)})},[]);function u(){t.current=!1}return E(function(){return t.current=!0,u},[]),[o,a]},Sr=function(r){var n=N(xr),e=Nr({fetching:!1,error:void 0,data:void 0}),o=e[1];function i(r){return o({fetching:!1,data:r.data,error:r.error}),r}return[e[0],q(function(e){o({fetching:!0,error:void 0,data:void 0});var a=L(r,e);return t(n.executeMutation(a),l).then(i)},[n,r,o])]},Pr=function(r,t){var n=k(void 0);return S(function(){var e=L(r,t);return void 0!==n.current&&n.current.key===e.key?n.current:(n.current=e,e)},[r,t])};function jr(r){return P({},r,{fetching:!0})}function _r(r){return P({},r,{fetching:!1})}!function(r){r[r.WillMount=0]="WillMount",r[r.DidMount=1]="DidMount",r[r.Update=2]="Update"}(kr||(kr={}));var Qr=function(r){var n=k(J),e=N(xr),i=Nr({fetching:!1,data:void 0,error:void 0}),a=i[0],u=i[1],c=Pr(r.query,r.variables);function s(r){u({fetching:!1,data:r.data,error:r.error})}var f=q(function(i){var a;n.current(),u(jr),a=t(e.executeQuery(c,P({requestPolicy:r.requestPolicy},i)),o(s)),n.current=a[0]},[r.requestPolicy,e,c,u]);function p(){return n.current()}return function(r,t){var n=k(void 0),e=k(kr.WillMount);e.current===kr.WillMount&&(e.current=kr.DidMount,n.current=r()),E(function(){return e.current===kr.Update?n.current=r():(e.current=kr.Update,n.current)},t)}(function(){return r.pause?(n.current(),u(_r)):(f(),p)},[f,r.pause,u]),[a,f]},Mr=function(r,n){var e=k(J),i=N(xr),a=Nr({fetching:!0,error:void 0,data:void 0}),u=a[0],c=a[1],s=Pr(r.query,r.variables);function f(r){var t=r.data,e=r.error;c(function(r){return{fetching:!0,data:void 0!==n?n(r.data,t):t,error:e}})}var p=q(function(){var r;e.current(),r=t(i.executeSubscription(s),o(f)),e.current=r[0]},[i,n,s,c]);function v(){return e.current()}return E(function(){return p(),v},[p]),[u]};function Ar(r){var t=r.children,n=Sr(r.query);return t(P({},n[0],{executeMutation:n[1]}))}function Dr(r,t){var n={};for(var e in r)Object.prototype.hasOwnProperty.call(r,e)&&t.indexOf(e)<0&&(n[e]=r[e]);if(null!=r&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(e=Object.getOwnPropertySymbols(r);o<e.length;o++)t.indexOf(e[o])<0&&(n[e[o]]=r[e[o]])}return n}function Rr(r){var t=r.children,n=Dr(r,["children"]),e=Qr(n);return t(P({},e[0],{executeQuery:e[1]}))}function Cr(r){var t=r.children,n=r.handler,e=Dr(r,["children","handler"]);return t(Mr(e,n)[0])}export{br as Client,M as CombinedError,Er as Consumer,xr as Context,Ar as Mutation,qr as Provider,Rr as Query,Cr as Subscription,Z as cacheExchange,$ as collectTypesFromResponse,mr as composeExchanges,Or as createClient,L as createRequest,cr as debugExchange,sr as dedupExchange,wr as defaultExchanges,gr as fallbackExchangeIO,pr as fetchExchange,T as formatDocument,C as getKeyForRequest,J as noop,z as ssrExchange,ir as subscriptionExchange,I as toSuspenseSource,Sr as useMutation,Qr as useQuery,Mr as useSubscription};
//# sourceMappingURL=urql.es.min.js.map
